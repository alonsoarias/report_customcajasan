{"version":3,"file":"report.min.js","sources":["../src/report.js"],"sourcesContent":["/**\n * JavaScript for the report_customcajasan report\n *\n * @module     block_report_customcajasan/report\n * @copyright  2025 Cajasan\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\ndefine(['jquery', 'core/notification', 'core/str'], function($, Notification, Str) {\n    // State management for current page and filters\n    var state = {\n        currentPage: 0,\n        filter: {}\n    };\n\n    /**\n     * Load report data via AJAX with improved handling\n     */\n    function loadReportData() {\n        // Show loading indicator\n        $('#report-results').addClass('loading');\n\n        // Get filter values\n        var formData = $('#report-form').serialize();\n        formData += '&page=' + state.currentPage;\n        formData += '&sesskey=' + M.cfg.sesskey;\n\n        // Make AJAX request\n        $.ajax({\n            url: M.cfg.wwwroot + '/blocks/report_customcajasan/ajax/get_report_data.php',\n            type: 'GET',\n            data: formData,\n            dataType: 'json',\n            success: function(response) {\n                if (response && response.success) {\n                    // Update report content\n                    $('#report-results').html(response.html);\n                    \n                    // Store total count in state\n                    state.totalCount = response.count;\n                    \n                    // Re-initialize pagination and other dynamic elements\n                    initializeDynamicElements();\n                    \n                    // Apply visual enhancements\n                    colorizeStatusCells();\n                } else {\n                    // Show error with better message handling\n                    var errorMsg = (response && response.error) ? response.error : \n                        M.util.get_string('ajax_error', 'block_report_customcajasan');\n                    \n                    $('#report-results').html(\n                        '<div class=\"alert alert-danger\">' + errorMsg + '</div>'\n                    );\n                }\n            },\n            error: function(xhr, status) {\n                // Show detailed error information\n                Str.get_string('ajax_error_detail', 'block_report_customcajasan')\n                    .then(function(errorString) {\n                        $('#report-results').html(\n                            '<div class=\"alert alert-danger\">' + errorString + ': ' + status + '</div>'\n                        );\n                        return;\n                    })\n                    .catch(Notification.exception);\n            },\n            complete: function() {\n                // Hide loading indicator\n                $('#report-results').removeClass('loading');\n            }\n        });\n    }\n\n    /**\n     * Initialize dynamic elements like pagination\n     */\n    function initializeDynamicElements() {\n        // Handle pagination with improved event delegation\n        $(document).off('click', '.pagination .page-link').on('click', '.pagination .page-link', function(e) {\n            e.preventDefault();\n            var page = $(this).data('page');\n\n            if (page !== undefined) {\n                state.currentPage = page;\n                loadReportData();\n                \n                // Scroll to top of results for better UX\n                $('html, body').animate({\n                    scrollTop: $('#report-results').offset().top - 20\n                }, 200);\n            }\n        });\n    }\n\n    /**\n     * Apply colors to status cells based on status values - updated for new status\n     */\n    function colorizeStatusCells() {\n        // Status cells are at column index 11 (0-based) - updated index\n        $('#enrollment-report-table tbody tr').each(function() {\n            var statusCell = $(this).find('td:eq(11)'); // Estado is at column 11 now\n            var statusText = statusCell.text().trim();\n\n            // Clear previous classes\n            statusCell.removeClass('bg-success bg-warning bg-info bg-secondary bg-danger text-white');\n\n            // Add appropriate class based on status - updated status values\n            if (statusText === 'APROBADO') {\n                statusCell.addClass('bg-success text-white');\n            } else if (statusText === 'EN CURSO') {\n                statusCell.addClass('bg-warning');\n            } else if (statusText === 'NO INICIADO') {\n                statusCell.addClass('bg-danger text-white');\n            } else if (statusText === 'SOLO CONSULTA') {\n                statusCell.addClass('bg-secondary text-white');\n            }\n        });\n    }\n\n    /**\n     * Initialize the module with improved filter handling\n     */\n    function init() {\n        // Handle category change - update courses\n        $('#categoryid').on('change', function() {\n            var categoryId = $(this).val();\n            state.filter.category = categoryId;\n            state.currentPage = 0;\n\n            // Clear course selection\n            $('#courseid').empty();\n            \n            // Add default \"All\" option\n            Str.get_string('option_all', 'block_report_customcajasan')\n                .then(function(allText) {\n                    $('#courseid').append($('<option>', {\n                        value: '',\n                        text: allText\n                    }));\n                })\n                .catch(function() {\n                    // Fallback si falla la carga del string\n                    $('#courseid').append($('<option>', {\n                        value: '',\n                        text: 'All'\n                    }));\n                });\n\n            if (categoryId) {\n                // Get courses for the selected category\n                $.ajax({\n                    url: M.cfg.wwwroot + '/blocks/report_customcajasan/ajax/get_courses.php',\n                    type: 'GET',\n                    data: {\n                        'categoryid': categoryId,\n                        'sesskey': M.cfg.sesskey\n                    },\n                    dataType: 'json',\n                    success: function(data) {\n                        if (data.success && data.courses) {\n                            $.each(data.courses, function(index, course) {\n                                $('#courseid').append($('<option>', {\n                                    value: course.id,\n                                    text: course.fullname\n                                }));\n                            });\n                        }\n                        // Reset to page 0 and load data\n                        state.currentPage = 0;\n                        loadReportData();\n                    },\n                    error: function(xhr, status) {\n                        // Show error using Moodle's notification API\n                        Notification.exception({message: 'Error loading courses: ' + status});\n                        // Reset to page 0 and load data anyway\n                        state.currentPage = 0;\n                        loadReportData();\n                    }\n                });\n            } else {\n                // If no category selected, reset to page 0 and load data\n                state.currentPage = 0;\n                loadReportData();\n            }\n        });\n\n        // Alphabet filter functionality with improved handling\n        $('.alphabet-filter a').on('click', function(e) {\n            e.preventDefault();\n            var letter = $(this).data('letter');\n            var target = $(this).data('target');\n\n            // Store in state\n            state.filter[target] = letter;\n            \n            // Update the hidden input with the selected letter\n            $('#' + target).val(letter);\n\n            // Update the UI to show active letter\n            $(this).closest('.alphabet-filter').find('a').removeClass('active');\n            $(this).addClass('active');\n\n            // Reset to page 0 and load data\n            state.currentPage = 0;\n            loadReportData();\n        });\n\n        // Handle filter form submission\n        $('#report-form').on('submit', function(e) {\n            e.preventDefault();\n            state.currentPage = 0;\n            loadReportData();\n        });\n\n        // Handle filter changes with clean event handling\n        $('#estado, #courseid').on('change', function() {\n            var id = $(this).attr('id');\n            state.filter[id] = $(this).val();\n            state.currentPage = 0;\n            loadReportData();\n        });\n\n        // Handle date changes\n        $('#startdate, #enddate').on('change', function() {\n            var id = $(this).attr('id');\n            state.filter[id] = $(this).val();\n            state.currentPage = 0;\n            loadReportData();\n        });\n\n        // Handle idnumber input with debounce for better performance\n        var idnumberTimer;\n        $('#idnumber').on('input', function() {\n            clearTimeout(idnumberTimer);\n            idnumberTimer = setTimeout(function() {\n                state.filter.idnumber = $('#idnumber').val();\n                state.currentPage = 0;\n                loadReportData();\n            }, 500); // 500ms debounce delay\n        });\n\n        // Initial load if filters are set\n        if ($('#report-results').length) {\n            var hasFilters = $('#categoryid').val() || $('#courseid').val() || $('#estado').val() ||\n                            $('#idnumber').val() || $('#firstname').val() || $('#lastname').val() ||\n                            $('#startdate').val() || $('#enddate').val();\n\n            // Initialize state from current form values\n            state.filter = {\n                category: $('#categoryid').val(),\n                course: $('#courseid').val(),\n                estado: $('#estado').val(),\n                idnumber: $('#idnumber').val(),\n                firstname: $('#firstname').val(),\n                lastname: $('#lastname').val(),\n                startdate: $('#startdate').val(),\n                enddate: $('#enddate').val()\n            };\n\n            if (hasFilters) {\n                loadReportData();\n            }\n        }\n\n        // Initialize any existing dynamic elements\n        initializeDynamicElements();\n    }\n\n    return {\n        init: init\n    };\n});"],"names":["define","$","Notification","Str","state","currentPage","filter","loadReportData","addClass","formData","serialize","M","cfg","sesskey","ajax","url","wwwroot","type","data","dataType","success","response","html","totalCount","count","initializeDynamicElements","each","statusCell","this","find","statusText","text","trim","removeClass","errorMsg","error","util","get_string","xhr","status","then","errorString","catch","exception","complete","document","off","on","e","preventDefault","page","undefined","animate","scrollTop","offset","top","init","idnumberTimer","categoryId","val","category","empty","allText","append","value","courses","index","course","id","fullname","message","letter","target","closest","attr","clearTimeout","setTimeout","idnumber","length","hasFilters","estado","firstname","lastname","startdate","enddate"],"mappings":"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"}