{"version":3,"file":"report.min.js","sources":["../src/report.js"],"sourcesContent":["/**\n * JavaScript for the report_customcajasan report\n *\n * @module     block_report_customcajasan/report\n * @copyright  2025 Cajasan\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\ndefine(['jquery', 'core/notification', 'core/str'], function($, Notification, Str) {\n    // State management for current page and filters\n    var state = {\n        currentPage: 0,\n        filter: {}\n    };\n\n    /**\n     * Update hidden fields in the download form with current filter values\n     */\n    function updateDownloadForm() {\n        // Update each hidden field in the download form\n        $('#downloadForm input[name=\"categoryid\"]').val($('#categoryid').val());\n        $('#downloadForm input[name=\"courseid\"]').val($('#courseid').val());\n        $('#downloadForm input[name=\"idnumber\"]').val($('#idnumber').val());\n        $('#downloadForm input[name=\"firstname\"]').val($('#firstname').val());\n        $('#downloadForm input[name=\"lastname\"]').val($('#lastname').val());\n        $('#downloadForm input[name=\"estado\"]').val($('#estado').val());\n        $('#downloadForm input[name=\"startdate\"]').val($('#startdate').val());\n        $('#downloadForm input[name=\"enddate\"]').val($('#enddate').val());\n    }\n\n    /**\n     * Load report data via AJAX with improved handling\n     */\n    function loadReportData() {\n        // Show loading indicator\n        $('#report-results').addClass('loading');\n\n        // Get filter values\n        var formData = $('#report-form').serialize();\n        formData += '&page=' + state.currentPage;\n        formData += '&sesskey=' + M.cfg.sesskey;\n\n        // Make AJAX request\n        $.ajax({\n            url: M.cfg.wwwroot + '/blocks/report_customcajasan/ajax/get_report_data.php',\n            type: 'GET',\n            data: formData,\n            dataType: 'json',\n            success: function(response) {\n                if (response && response.success) {\n                    // Update report content\n                    $('#report-results').html(response.html);\n                    \n                    // Store total count in state\n                    state.totalCount = response.count;\n                    \n                    // Re-initialize pagination and other dynamic elements\n                    initializeDynamicElements();\n                    \n                    // Apply visual enhancements\n                    colorizeStatusCells();\n                    \n                    // Update download form with current filters\n                    updateDownloadForm();\n                } else {\n                    // Show error with better message handling\n                    var errorMsg = (response && response.error) ? response.error : \n                        M.util.get_string('ajax_error', 'block_report_customcajasan');\n                    \n                    $('#report-results').html(\n                        '<div class=\"alert alert-danger\">' + errorMsg + '</div>'\n                    );\n                }\n            },\n            error: function(xhr, status) {\n                // Show detailed error information\n                Str.get_string('ajax_error_detail', 'block_report_customcajasan')\n                    .then(function(errorString) {\n                        $('#report-results').html(\n                            '<div class=\"alert alert-danger\">' + errorString + ': ' + status + '</div>'\n                        );\n                        return;\n                    })\n                    .catch(Notification.exception);\n            },\n            complete: function() {\n                // Hide loading indicator\n                $('#report-results').removeClass('loading');\n            }\n        });\n    }\n\n    /**\n     * Initialize dynamic elements like pagination\n     */\n    function initializeDynamicElements() {\n        // Handle pagination with improved event delegation\n        $(document).off('click', '.pagination .page-link').on('click', '.pagination .page-link', function(e) {\n            e.preventDefault();\n            var page = $(this).data('page');\n\n            if (page !== undefined) {\n                state.currentPage = page;\n                loadReportData();\n                \n                // Scroll to top of results for better UX\n                $('html, body').animate({\n                    scrollTop: $('#report-results').offset().top - 20\n                }, 200);\n            }\n        });\n    }\n\n    /**\n     * Apply colors to status cells based on status values - updated for new status\n     */\n    function colorizeStatusCells() {\n        // Status cells are at column index 11 (0-based) - updated index\n        $('#enrollment-report-table tbody tr').each(function() {\n            var statusCell = $(this).find('td:eq(11)'); // Estado is at column 11 now\n            var statusText = statusCell.text().trim();\n\n            // Clear previous classes\n            statusCell.removeClass('bg-success bg-warning bg-info bg-secondary bg-danger text-white');\n\n            // Add appropriate class based on status - updated status values\n            if (statusText === 'APROBADO') {\n                statusCell.addClass('bg-success text-white');\n            } else if (statusText === 'EN CURSO') {\n                statusCell.addClass('bg-warning');\n            } else if (statusText === 'NO INICIADO') {\n                statusCell.addClass('bg-danger text-white');\n            } else if (statusText === 'SOLO CONSULTA') {\n                statusCell.addClass('bg-secondary text-white');\n            }\n        });\n    }\n\n    /**\n     * Initialize the module with improved filter handling\n     */\n    function init() {\n        // Handle category change - update courses\n        $('#categoryid').on('change', function() {\n            var categoryId = $(this).val();\n            state.filter.category = categoryId;\n            state.currentPage = 0;\n\n            // Clear course selection\n            $('#courseid').empty();\n            \n            // Add default \"All\" option\n            Str.get_string('option_all', 'block_report_customcajasan')\n                .then(function(allText) {\n                    $('#courseid').append($('<option>', {\n                        value: '',\n                        text: allText\n                    }));\n                })\n                .catch(function() {\n                    // Fallback si falla la carga del string\n                    $('#courseid').append($('<option>', {\n                        value: '',\n                        text: 'All'\n                    }));\n                });\n\n            if (categoryId) {\n                // Get courses for the selected category\n                $.ajax({\n                    url: M.cfg.wwwroot + '/blocks/report_customcajasan/ajax/get_courses.php',\n                    type: 'GET',\n                    data: {\n                        'categoryid': categoryId,\n                        'sesskey': M.cfg.sesskey\n                    },\n                    dataType: 'json',\n                    success: function(data) {\n                        if (data.success && data.courses) {\n                            $.each(data.courses, function(index, course) {\n                                $('#courseid').append($('<option>', {\n                                    value: course.id,\n                                    text: course.fullname\n                                }));\n                            });\n                        }\n                        // Reset to page 0 and load data\n                        state.currentPage = 0;\n                        loadReportData();\n                    },\n                    error: function(xhr, status) {\n                        // Show error using Moodle's notification API\n                        Notification.exception({message: 'Error loading courses: ' + status});\n                        // Reset to page 0 and load data anyway\n                        state.currentPage = 0;\n                        loadReportData();\n                    }\n                });\n            } else {\n                // If no category selected, reset to page 0 and load data\n                state.currentPage = 0;\n                loadReportData();\n            }\n        });\n\n        // Alphabet filter functionality with improved handling\n        $('.alphabet-filter a').on('click', function(e) {\n            e.preventDefault();\n            var letter = $(this).data('letter');\n            var target = $(this).data('target');\n\n            // Store in state\n            state.filter[target] = letter;\n            \n            // Update the hidden input with the selected letter\n            $('#' + target).val(letter);\n\n            // Update the UI to show active letter\n            $(this).closest('.alphabet-filter').find('a').removeClass('active');\n            $(this).addClass('active');\n\n            // Reset to page 0 and load data\n            state.currentPage = 0;\n            loadReportData();\n        });\n\n        // Handle filter form submission\n        $('#report-form').on('submit', function(e) {\n            e.preventDefault();\n            state.currentPage = 0;\n            loadReportData();\n        });\n\n        // Handle filter changes with clean event handling\n        $('#estado, #courseid').on('change', function() {\n            var id = $(this).attr('id');\n            state.filter[id] = $(this).val();\n            state.currentPage = 0;\n            loadReportData();\n        });\n\n        // Handle date changes\n        $('#startdate, #enddate').on('change', function() {\n            var id = $(this).attr('id');\n            state.filter[id] = $(this).val();\n            state.currentPage = 0;\n            loadReportData();\n        });\n\n        // Handle idnumber input with debounce for better performance\n        var idnumberTimer;\n        $('#idnumber').on('input', function() {\n            clearTimeout(idnumberTimer);\n            idnumberTimer = setTimeout(function() {\n                state.filter.idnumber = $('#idnumber').val();\n                state.currentPage = 0;\n                loadReportData();\n            }, 500); // 500ms debounce delay\n        });\n\n        // Initialize download button to update form fields before submission\n        $('#downloadForm').on('submit', function() {\n            // Update form with current filter values right before submission\n            updateDownloadForm();\n            return true; // Allow form submission to continue\n        });\n\n        // Initial load if filters are set\n        if ($('#report-results').length) {\n            var hasFilters = $('#categoryid').val() || $('#courseid').val() || $('#estado').val() ||\n                            $('#idnumber').val() || $('#firstname').val() || $('#lastname').val() ||\n                            $('#startdate').val() || $('#enddate').val();\n\n            // Initialize state from current form values\n            state.filter = {\n                category: $('#categoryid').val(),\n                course: $('#courseid').val(),\n                estado: $('#estado').val(),\n                idnumber: $('#idnumber').val(),\n                firstname: $('#firstname').val(),\n                lastname: $('#lastname').val(),\n                startdate: $('#startdate').val(),\n                enddate: $('#enddate').val()\n            };\n\n            if (hasFilters) {\n                loadReportData();\n            }\n        }\n\n        // Initialize any existing dynamic elements\n        initializeDynamicElements();\n    }\n\n    return {\n        init: init\n    };\n});"],"names":["define","$","Notification","Str","state","currentPage","filter","updateDownloadForm","val","loadReportData","addClass","formData","serialize","M","cfg","sesskey","ajax","url","wwwroot","type","data","dataType","success","response","html","totalCount","count","initializeDynamicElements","each","statusCell","this","find","statusText","text","trim","removeClass","errorMsg","error","util","get_string","xhr","status","then","errorString","catch","exception","complete","document","off","on","e","preventDefault","page","undefined","animate","scrollTop","offset","top","init","idnumberTimer","categoryId","category","empty","allText","append","value","courses","index","course","id","fullname","message","letter","target","closest","attr","clearTimeout","setTimeout","idnumber","length","hasFilters","estado","firstname","lastname","startdate","enddate"],"mappings":"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"}