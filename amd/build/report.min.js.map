{"version":3,"file":"report.min.js","sources":["../src/report.js"],"sourcesContent":["/**\n * JavaScript for the report_customcajasan report\n *\n * @module     block_report_customcajasan/report\n * @copyright  2025 Cajasan\n * @author     Pedro Arias <soporte@ingeweb.co>\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\ndefine(['jquery', 'core/notification', 'core/str'], function($, Notification, Str) {\n    // State management for current page and filters\n    var state = {\n        currentPage: 0,\n        perPage: 100, // Default value\n        filter: {}\n    };\n\n    /**\n     * Update hidden fields in the download form with current filter values\n     */\n    function updateDownloadForm() {\n        // Update each hidden field in the download form\n        $('#downloadForm input[name=\"categoryid\"]').val($('#categoryid').val());\n        $('#downloadForm input[name=\"courseid\"]').val($('#courseid').val());\n        $('#downloadForm input[name=\"idnumber\"]').val($('#idnumber').val());\n        $('#downloadForm input[name=\"firstname\"]').val($('#firstname').val());\n        $('#downloadForm input[name=\"lastname\"]').val($('#lastname').val());\n        $('#downloadForm input[name=\"estado\"]').val($('#estado').val());\n        $('#downloadForm input[name=\"startdate\"]').val($('#startdate').val());\n        $('#downloadForm input[name=\"enddate\"]').val($('#enddate').val());\n    }\n\n    /**\n     * Load report data via AJAX with improved handling\n     */\n    function loadReportData() {\n        // Show loading indicator\n        $('#report-results').addClass('loading');\n\n        // Get filter values\n        var formData = $('#report-form').serialize();\n        formData += '&page=' + state.currentPage;\n        \n        // Add perpage parameter if set\n        if (state.perPage !== undefined) {\n            formData += '&perpage=' + state.perPage;\n        }\n        \n        formData += '&sesskey=' + M.cfg.sesskey;\n\n        // Make AJAX request\n        $.ajax({\n            url: M.cfg.wwwroot + '/blocks/report_customcajasan/ajax/get_report_data.php',\n            type: 'GET',\n            data: formData,\n            dataType: 'json',\n            success: function(response) {\n                if (response && response.success) {\n                    // Update report content\n                    $('#report-results').html(response.html);\n                    \n                    // Store total count in state\n                    state.totalCount = response.count;\n                    \n                    // Re-initialize pagination and other dynamic elements\n                    initializeDynamicElements();\n                    \n                    // Apply visual enhancements\n                    colorizeStatusCells();\n                    \n                    // Update download form with current filters\n                    updateDownloadForm();\n                } else {\n                    // Show error with better message handling\n                    var errorMsg = (response && response.error) ? response.error : \n                        M.util.get_string('ajax_error', 'block_report_customcajasan');\n                    \n                    $('#report-results').html(\n                        '<div class=\"alert alert-danger\">' + errorMsg + '</div>'\n                    );\n                }\n            },\n            error: function(xhr, status) {\n                // Show detailed error information\n                Str.get_string('ajax_error_detail', 'block_report_customcajasan')\n                    .then(function(errorString) {\n                        $('#report-results').html(\n                            '<div class=\"alert alert-danger\">' + errorString + ': ' + status + '</div>'\n                        );\n                        return;\n                    })\n                    .catch(Notification.exception);\n            },\n            complete: function() {\n                // Hide loading indicator\n                $('#report-results').removeClass('loading');\n            }\n        });\n    }\n\n    /**\n     * Initialize dynamic elements like pagination\n     */\n    function initializeDynamicElements() {\n        // Handle pagination with improved event delegation\n        $(document).off('click', '.pagination .page-link').on('click', '.pagination .page-link', function(e) {\n            e.preventDefault();\n            var page = $(this).data('page');\n\n            if (page !== undefined) {\n                state.currentPage = page;\n                loadReportData();\n                \n                // Scroll to top of results for better UX\n                $('html, body').animate({\n                    scrollTop: $('#report-results').offset().top - 20\n                }, 200);\n            }\n        });\n    }\n\n    /**\n     * Apply colors to status cells based on status values - updated for new status\n     */\n    function colorizeStatusCells() {\n        // Status cells are at column index 10 (0-based) - updated index after removing fecha_finalizacion\n        $('#enrollment-report-table tbody tr').each(function() {\n            var statusCell = $(this).find('td:eq(10)'); // Estado is at column 10 now\n            var statusText = statusCell.text().trim();\n\n            // Clear previous classes\n            statusCell.removeClass('bg-success bg-warning bg-info bg-secondary bg-danger text-white');\n\n            // Add appropriate class based on status - updated status values\n            if (statusText === 'APROBADO') {\n                statusCell.addClass('bg-success text-white');\n            } else if (statusText === 'EN CURSO') {\n                statusCell.addClass('bg-warning');\n            } else if (statusText === 'NO INICIADO') {\n                statusCell.addClass('bg-danger text-white');\n            } else if (statusText === 'SOLO CONSULTA') {\n                statusCell.addClass('bg-secondary text-white');\n            }\n        });\n    }\n\n    /**\n     * Initialize the module with improved filter handling\n     */\n    function init() {\n        // Handle category change - update courses\n        $('#categoryid').on('change', function() {\n            var categoryId = $(this).val();\n            state.filter.category = categoryId;\n            state.currentPage = 0;\n\n            // Clear course selection\n            $('#courseid').empty();\n            \n            // Add default \"All\" option\n            Str.get_string('option_all', 'block_report_customcajasan')\n                .then(function(allText) {\n                    $('#courseid').append($('<option>', {\n                        value: '',\n                        text: allText\n                    }));\n                })\n                .catch(function() {\n                    // Fallback si falla la carga del string\n                    $('#courseid').append($('<option>', {\n                        value: '',\n                        text: 'All'\n                    }));\n                });\n\n            if (categoryId) {\n                // Get courses for the selected category\n                $.ajax({\n                    url: M.cfg.wwwroot + '/blocks/report_customcajasan/ajax/get_courses.php',\n                    type: 'GET',\n                    data: {\n                        'categoryid': categoryId,\n                        'sesskey': M.cfg.sesskey\n                    },\n                    dataType: 'json',\n                    success: function(data) {\n                        if (data.success && data.courses) {\n                            $.each(data.courses, function(index, course) {\n                                $('#courseid').append($('<option>', {\n                                    value: course.id,\n                                    text: course.fullname\n                                }));\n                            });\n                        }\n                        // Reset to page 0 and load data\n                        state.currentPage = 0;\n                        loadReportData();\n                        updateDownloadForm(); // Actualizar campos ocultos después de cargar cursos\n                    },\n                    error: function(xhr, status) {\n                        // Show error using Moodle's notification API\n                        Notification.exception({message: 'Error loading courses: ' + status});\n                        // Reset to page 0 and load data anyway\n                        state.currentPage = 0;\n                        loadReportData();\n                        updateDownloadForm(); // Actualizar campos ocultos incluso si hay error\n                    }\n                });\n            } else {\n                // If no category selected, reset to page 0 and load data\n                state.currentPage = 0;\n                loadReportData();\n                updateDownloadForm(); // Actualizar campos ocultos\n            }\n        });\n\n        // Alphabet filter functionality with improved handling\n        $('.alphabet-filter a').on('click', function(e) {\n            e.preventDefault();\n            var letter = $(this).data('letter');\n            var target = $(this).data('target');\n\n            // Store in state\n            state.filter[target] = letter;\n            \n            // Update the hidden input with the selected letter\n            $('#' + target).val(letter);\n\n            // Update the UI to show active letter\n            $(this).closest('.alphabet-filter').find('a').removeClass('active');\n            $(this).addClass('active');\n\n            // Reset to page 0 and load data\n            state.currentPage = 0;\n            loadReportData();\n            updateDownloadForm(); // Actualizar campos ocultos después de filtrar por letra\n        });\n\n        // Handle filter form submission\n        $('#report-form').on('submit', function(e) {\n            e.preventDefault();\n            state.currentPage = 0;\n            loadReportData();\n            updateDownloadForm(); // Actualizar campos ocultos después de enviar formulario\n        });\n\n        // Handle filter changes with clean event handling\n        $('#estado, #courseid').on('change', function() {\n            var id = $(this).attr('id');\n            state.filter[id] = $(this).val();\n            state.currentPage = 0;\n            loadReportData();\n            updateDownloadForm(); // Actualizar campos ocultos después de cambiar selección\n        });\n\n        // Handle date changes\n        $('#startdate, #enddate').on('change', function() {\n            var id = $(this).attr('id');\n            state.filter[id] = $(this).val();\n            state.currentPage = 0;\n            loadReportData();\n            updateDownloadForm(); // Actualizar campos ocultos después de cambiar fecha\n        });\n\n        // Handle idnumber input with debounce for better performance\n        var idnumberTimer;\n        $('#idnumber').on('input', function() {\n            clearTimeout(idnumberTimer);\n            idnumberTimer = setTimeout(function() {\n                state.filter.idnumber = $('#idnumber').val();\n                state.currentPage = 0;\n                loadReportData();\n                updateDownloadForm(); // Actualizar campos ocultos después del debounce\n            }, 500); // 500ms debounce delay\n        });\n        \n        // Handle per page change\n        $('#perpage').on('change', function() {\n            var perpage = parseInt($(this).val());\n            state.perPage = perpage; // Store in state\n            state.currentPage = 0; // Reset to first page when changing page size\n            loadReportData();\n        });\n\n        // Initialize download button to update form fields before submission\n        $('#downloadForm').on('submit', function() {\n            // Update form with current filter values right before submission\n            updateDownloadForm();\n            \n            // Opcional: Verificar que al menos un filtro esté aplicado\n            var hasFilters = $('#downloadForm input[name=\"categoryid\"]').val() || \n                             $('#downloadForm input[name=\"courseid\"]').val() || \n                             $('#downloadForm input[name=\"estado\"]').val() ||\n                             $('#downloadForm input[name=\"idnumber\"]').val() || \n                             $('#downloadForm input[name=\"firstname\"]').val() || \n                             $('#downloadForm input[name=\"lastname\"]').val() ||\n                             $('#downloadForm input[name=\"startdate\"]').val() || \n                             $('#downloadForm input[name=\"enddate\"]').val();\n            \n            if (!hasFilters) {\n                // Mostrar una notificación si no hay filtros seleccionados\n                Notification.alert(\n                    '',\n                    M.util.get_string('filters_required', 'block_report_customcajasan')\n                );\n                return false; // Evitar la descarga sin filtros\n            }\n            \n            return true; // Permitir que continúe el envío del formulario\n        });\n\n        // Initial load if filters are set\n        if ($('#report-results').length) {\n            var hasFilters = $('#categoryid').val() || $('#courseid').val() || $('#estado').val() ||\n                            $('#idnumber').val() || $('#firstname').val() || $('#lastname').val() ||\n                            $('#startdate').val() || $('#enddate').val();\n\n            // Initialize state from current form values\n            state.filter = {\n                category: $('#categoryid').val(),\n                course: $('#courseid').val(),\n                estado: $('#estado').val(),\n                idnumber: $('#idnumber').val(),\n                firstname: $('#firstname').val(),\n                lastname: $('#lastname').val(),\n                startdate: $('#startdate').val(),\n                enddate: $('#enddate').val()\n            };\n            \n            // Initialize perPage\n            state.perPage = $('#perpage').val() ? parseInt($('#perpage').val()) : 100;\n\n            if (hasFilters) {\n                loadReportData();\n                updateDownloadForm(); // Actualizar campos ocultos en la carga inicial\n            }\n        }\n\n        // Initialize any existing dynamic elements\n        initializeDynamicElements();\n    }\n\n    return {\n        init: init\n    };\n});"],"names":["define","$","Notification","Str","state","currentPage","perPage","filter","updateDownloadForm","val","loadReportData","addClass","formData","serialize","undefined","M","cfg","sesskey","ajax","url","wwwroot","type","data","dataType","success","response","html","totalCount","count","initializeDynamicElements","each","statusCell","this","find","statusText","text","trim","removeClass","errorMsg","error","util","get_string","xhr","status","then","errorString","catch","exception","complete","document","off","on","e","preventDefault","page","animate","scrollTop","offset","top","init","idnumberTimer","categoryId","category","empty","allText","append","value","courses","index","course","id","fullname","message","letter","target","closest","attr","clearTimeout","setTimeout","idnumber","perpage","parseInt","alert","length","hasFilters","estado","firstname","lastname","startdate","enddate"],"mappings":"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"}